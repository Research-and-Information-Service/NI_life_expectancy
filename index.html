<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NI DEA Life Expectancy Map</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://unpkg.com/chart.js@4.3.0/dist/chart.umd.js"></script>
<!-- Chart.js Annotation Plugin -->
<script src="https://unpkg.com/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script>Chart.register(window['chartjs-plugin-annotation']);</script>

<style>
:root{
  --control-width: 220px;
  --control-font: 13px;
  --sidebar-width: 360px;
  --chart-height: 220px;
  --ui-bg: rgba(255,255,255,0.98);
  --muted: #666;
  --accent: #0078A8;
  --legend-width: 160px;
}

html,body { height:100%; margin:0; font-family: Arial, sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
#map { height:100vh; width:100%; }

/* Controls */
.controls {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 1200;
  background: var(--ui-bg);
  padding: 8px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.18);
  width: var(--control-width);
  font-size: var(--control-font);
  transition: transform .18s ease, opacity .18s ease;
}
.controls.min { transform: translateY(-6px) scale(.98); opacity:.94; }
.control-toggle { position:absolute; right:6px; top:6px; border:none; background:transparent; cursor:pointer; color:var(--muted); font-size:14px; }

.tabs { display:flex; gap:6px; margin-bottom:6px; }
.tabs button { flex:1; padding:6px 8px; border: none; background:#eee; border-radius:4px; cursor:pointer; }
.tabs button.active { background:var(--accent); color:white; }

#year-slider { width:100%; margin-top:8px; }
#year-label { margin-top:6px; font-weight:700; font-size:13px; }
#play-btn { margin-top:8px; padding:6px 10px; background:#eee; border-radius:4px; cursor:pointer; border:none; }

.small-note { font-size:12px; color:var(--muted); margin-top:8px; }

/* Tooltip (info) */
.info { display:inline-block; border-radius:50%; width:18px; height:18px; text-align:center; line-height:18px; font-size:12px; background:#f0f0f0; color:#333; margin-left:6px; cursor:help; position:relative; }
.info-tip { display:none; position:absolute; left:22px; top:-6px; width:240px; background:#fff; border:1px solid #ddd; padding:8px; font-size:12px; color:#222; border-radius:4px; box-shadow:0 2px 6px rgba(0,0,0,0.12); z-index:2500; }
.info:hover .info-tip { display:block; }

/* Legend */
.legend {
  width: auto;
  min-width: 0;
  padding: 6px 8px;
  line-height: 1.3;
  font-size: 12px;
  background: rgba(255,255,255,0.95);
  border-radius: 6px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.12);
}

.legend-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-bottom: 4px;
}

.legend-swatch {
  width: 18px;
  height: 14px;
  border-radius: 3px;
  flex: 0 0 auto;
}

.legend-item > div {
  white-space: nowrap;
}

/* Sidebar */
#sidebar {
  position:absolute; right:10px; top:10px;
  z-index:1200;
  width:var(--sidebar-width);
  max-height: calc(100vh - 20px);
  overflow:auto;
  background: var(--ui-bg);
  padding:10px;
  border-radius:6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.18);
  display:none;
}
#sidebar h3 { margin:0 0 6px 0; font-size:16px; }
#sidebar-meta { margin-bottom:8px; color:var(--muted); font-size:13px; }
#chart-container { height:var(--chart-height); }

/* DEA label */
.dea-label {
  display:inline-block;
  font-weight:700;
  font-size:13px;
  line-height:1;
  padding:6px 8px;
  border-radius:6px;
  background: rgba(255,255,255,0.9);
  color:#111;
  text-align:center;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
  transform: translate(-50%,-50%);
  pointer-events:none;
}

/* Spinner */
#spinner { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); z-index:2000; display:none; }
.spinner-dot { width:14px; height:14px; margin:4px; border-radius:50%; background:var(--accent); display:inline-block; animation: spin 0.9s linear infinite; }
@keyframes spin { 0%{transform:scale(1);}50%{transform:scale(.45);}100%{transform:scale(1);} }

/* Logo */
#assembly-logo { position:absolute; bottom:10px; left:10px; width:120px; z-index:1100; opacity:0.95; pointer-events:none; }

/* Responsive */
@media (max-width:900px){
  :root{ --control-width:260px; --sidebar-width:300px; --chart-height:180px; --control-font:13px; --legend-width:140px; }
  #assembly-logo{ width:98px; }
}
@media (max-width:650px){
  :root{ 
    --control-width:200px; 
    --sidebar-width:240px; 
    --chart-height:150px; 
    --control-font:12px; 
    --legend-width:120px; 
  }
  .controls{ left:8px; top:8px; padding:6px; }
  .controls.min{ transform:none; opacity:1; }
  .legend{ display:none; }
  #assembly-logo{ width:86px; left:8px; bottom:8px; }
  #sidebar { top:5px; right:5px; width:90%; max-height:90vh; padding:8px; overflow:auto; }
  #chart-container { height:40vh; min-height:150px; }
}

/* NI Average label */
#ni-average-label {
  font-size:12px;
  color:#444;
  font-weight:bold;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
#ni-average-label .ni-average-line {
  height:2px;
  background: repeating-linear-gradient(to right, #444 0, #444 5px, transparent 5px, transparent 10px);
  display:inline-block;
}
</style>
</head>
<body>

<div id="map"></div>
<img id="assembly-logo" src="NI_Assembly.svg" alt="NI Assembly Logo" />

<div id="spinner">
  <div class="spinner-dot"></div>
  <div class="spinner-dot" style="animation-delay:.12s"></div>
  <div class="spinner-dot" style="animation-delay:.24s"></div>
</div>

<!-- Controls -->
<div class="controls" id="controls" role="region" aria-label="Map controls">
  <button class="control-toggle" id="controls-toggle" title="Collapse controls">▾</button>
  <div class="tabs" role="tablist" aria-label="Sex selection">
    <button id="tab-males" class="active" aria-selected="true">Males</button>
    <button id="tab-females" aria-selected="false">Females</button>
  </div>
  <input type="range" id="year-slider" min="0" max="0" step="1" aria-label="Year slider" />
  <div id="year-label" aria-live="polite"></div>
  <button id="play-btn" aria-pressed="false">▶ Play Years</button>
  <div class="small-note">
    <b>Data Display Mode</b>
    <span class="info">ⓘ
      <div class="info-tip">
        <strong>Data by year:</strong> colours & legend update based only on the selected year.<br><br>
        <strong>Data across years:</strong> colours & legend use the full NI range across all years.
      </div>
    </span>
    <label style="display:block; margin-top:6px;"><input type="radio" name="yaxis" value="dynamic"> Data by year</label>
    <label style="display:block; margin-top:6px;"><input type="radio" name="yaxis" value="fixed" checked> Data across years</label>
  </div>
</div>

<!-- Sidebar -->
<div id="sidebar" aria-live="polite" role="region" aria-label="DEA details">
  <button id="close-sidebar" style="float:right">Close</button>
  <h3 id="sidebar-title"></h3>
  <div id="sidebar-meta"></div>
  <div id="chart-container">
    <div id="ni-average-label">
      <span>NI average:</span>
      <span class="ni-average-line"></span>
    </div>
    <canvas id="deaChart"></canvas>
  </div>
</div>

<script>
// ... Your existing JS code here ...

// Update NI line width dynamically
function updateSidebarChartForSelectedYear(){
  if (!deaChart) return;
  const idx = currentYearIndex;
  const ann = deaChart.options.plugins.annotation.annotations;
  if (ann) {
    if (ann.currentYearLine) { ann.currentYearLine.xMin = idx; ann.currentYearLine.xMax = idx; }
    if (ann.shadeLeft) { ann.shadeLeft.xMax = idx; }
    deaChart.update();
  }

  const chartCanvas = document.getElementById('deaChart');
  const niLine = document.querySelector('#ni-average-label .ni-average-line');
  if (chartCanvas && niLine) {
    niLine.style.width = chartCanvas.offsetWidth + 'px';
  }
}

// When initializing chart
setTimeout(() => {
  if (lastSelectedLayer) populateSidebar(lastSelectedLayer.feature);
}, 50);

// Resize chart on window resize
window.addEventListener('resize', () => {
  if (deaChart) deaChart.resize();
  const chartCanvas = document.getElementById('deaChart');
  const niLine = document.querySelector('#ni-average-label .ni-average-line');
  if (chartCanvas && niLine) niLine.style.width = chartCanvas.offsetWidth + 'px';
});
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NI DEA Life Expectancy Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://unpkg.com/chart.js@4.3.0/dist/chart.umd.js"></script>

  <!-- Chart.js Annotation Plugin -->
  <script src="https://unpkg.com/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script>Chart.register(window['chartjs-plugin-annotation']);</script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; }

    .controls {
      position: absolute;
      top: 10px; left: 10px; z-index: 1000;
      background: white; padding: 10px; border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      width: 300px;
    }
    .tabs button {
      margin: 2px; padding: 6px 10px; border: none; cursor: pointer;
      background: #eee; border-radius: 4px;
    }
    .tabs button.active { background: #0078A8; color: white; }

    #year-slider { width: 100%; }

    #play-btn {
      margin-top: 6px; padding: 6px 10px;
      background: #eee; border-radius: 4px; cursor: pointer;
    }

    .legend { background: white; padding: 6px; border-radius: 4px; font-size: 12px; }
    .legend i {
      width: 18px; height: 18px;
      float: left; margin-right: 8px;
      opacity: 0.95;
    }

    /* Sidebar */
    #sidebar {
      position: absolute;
      right: 10px;
      top: 10px;
      width: 360px;
      max-height: calc(100vh - 20px);
      overflow: auto;
      z-index: 1000;
      background: white;
      padding: 12px;
      border-radius: 6px;
      display: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    #chart-container { height: 220px; }

    /* Spinner */
    #spinner {
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 2000;
    }

    .spinner-dot {
      width: 16px; height: 16px; margin: 4px;
      border-radius: 50%;
      background: #0078A8; opacity: 0.9;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { 0% {transform:scale(1);} 50% {transform:scale(0.45);} 100% {transform:scale(1);} }

    .leaflet-interactive {
      transition: fill 600ms ease, fill-opacity 600ms ease, stroke 300ms ease;
    }

    /* logo bottom-left */
    #assembly-logo {
      position: absolute;
      bottom: 10px;
      left: 10px;
      width: 140px;
      z-index: 1100;
      opacity: 0.95;
      pointer-events: none;
    }
  </style>
</head>

<body>

  <div id="map"></div>
  <img id="assembly-logo" src="NI_Assembly.svg" alt="NI Assembly Logo">

  <div id="spinner">
    <div class="spinner-dot" style="animation-delay:0s"></div>
    <div class="spinner-dot" style="animation-delay:0.15s"></div>
    <div class="spinner-dot" style="animation-delay:0.3s"></div>
  </div>

  <div class="controls">
    <div class="tabs">
      <button id="tab-males" class="active">Males</button>
      <button id="tab-females">Females</button>
    </div>

    <input type="range" id="year-slider" min="0" max="0" step="1" value="0">
    <div id="year-label" style="margin-top:5px;font-weight:bold;"></div>

    <button id="play-btn">▶ Play Years</button>

    <div style="margin-top:10px;">
      <label><input type="radio" name="mode" value="absolute" checked> Absolute</label><br>
      <label><input type="radio" name="mode" value="change"> Change</label>
    </div>
  </div>

  <div id="sidebar">
    <button id="close-sidebar" style="float:right">Close</button>
    <h3 id="sidebar-title"></h3>
    <div id="sidebar-meta"></div>
    <div id="chart-container"><canvas id="deaChart"></canvas></div>
  </div>

  <script>
  /* =====================================================
     CONFIG — ColorBrewer GnBu 7-class (INVERTED)
     darkest(low) → lightest(high)
  ====================================================== */

  const colors = [
    "#28326f",
    "#265188",
    "#246b9e",
    "#2285b3",
    "#6baccb",
    "#b4d2e3",
    "#dee8f1"
  ];

  const changeColors = colors.slice(); // keep consistent style for change (optional)

  const geojsonUrl = "DEA_data.geojson";

  let selectedSex = "Males";
  let years = [];
  let currentYearIndex = 0;
  let playInterval = null;
  let mode = "absolute";
  let breaks = [];

  const map = L.map("map").setView([54.7, -6.6], 8);
  L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png").addTo(map);

  const legend = L.control({position:"bottomright"});
  legend.onAdd = () => {
    const div = L.DomUtil.create("div", "legend");
    div.innerHTML = `<div id="legend-content"></div>`;
    return div;
  };
  legend.addTo(map);

  const spinner = document.getElementById("spinner");
  function showSpinner(on=true){ spinner.style.display = on ? "block" : "none"; }

  let deaLayer = null;
  let deaDataCache = null;
  let lastHoveredLayer = null;
  let deaChart = null;

  showSpinner(true);

  fetch(geojsonUrl)
    .then(r => r.json())
    .then(data => {
      deaDataCache = data;

      const yearSet = new Set();
      data.features.forEach(f => {
        (f.properties.data || []).forEach(d => yearSet.add(d.GroupedYear));
      });

      years = Array.from(yearSet).sort();
      document.getElementById("year-slider").max = years.length - 1;
      updateYearLabel();

      computeBreaks(data);

      const highlight = { weight: 3, color: "#000", fillOpacity: 1 };

      deaLayer = L.geoJSON(data, {
        style: feature => ({
          weight: 1, color: "#555",
          fillColor: getFeatureColor(feature),
          fillOpacity: 0.85
        }),
        onEachFeature: (feature, layer) => {
          layer.on("mouseover", () => {
            if (lastHoveredLayer && lastHoveredLayer !== layer)
              deaLayer.resetStyle(lastHoveredLayer);

            lastHoveredLayer = layer;
            layer.setStyle(highlight);
            populateSidebar(feature);
            document.getElementById("sidebar").style.display = "block";
          });

          layer.on("mouseout", () => {
            deaLayer.resetStyle(layer);
            lastHoveredLayer = null;
            document.getElementById("sidebar").style.display = "none";
            if (deaChart) deaChart.destroy();
          });
        }
      }).addTo(map);

      map.fitBounds(deaLayer.getBounds(), {padding:[20,20]});
      updateLegend();
      showSpinner(false);
    });

  /* =====================================================
     HELPER FUNCTIONS
  ====================================================== */

  function round1(v){ return Math.round(v * 10) / 10; }

  function featureValue(feature){
    const rec = (feature.properties.data || []).find(
      d => d.Sex === selectedSex && d.GroupedYear === years[currentYearIndex]
    );
    return rec ? rec.Value : null;
  }

  /* Equal-interval breaks for 7 classes */
  function computeBreaks(data){
    const vals = [];

    data.features.forEach(f => {
      const rec = (f.properties.data || []).find(
        d => d.Sex === selectedSex && d.GroupedYear === years[currentYearIndex]
      );
      if (rec && typeof rec.Value === "number") vals.push(rec.Value);
    });

    if (vals.length === 0){ breaks = []; return; }

    const min = Math.min(...vals);
    const max = Math.max(...vals);
    const step = (max - min) / 7;

    breaks = Array.from({length:6},(_,i)=> round1(min + step*(i+1)));
  }

  function getFeatureColor(feature){
    if (mode === "absolute"){
      const val = featureValue(feature);
      if (val == null) return "#ccc";

      if (val <= breaks[0]) return colors[0];
      if (val <= breaks[1]) return colors[1];
      if (val <= breaks[2]) return colors[2];
      if (val <= breaks[3]) return colors[3];
      if (val <= breaks[4]) return colors[4];
      if (val <= breaks[5]) return colors[5];
      return colors[6];
    }

    /* Change mode uses same colours for now */
    const fYr = years[0], lYr = years[years.length-1];
    const a = (feature.properties.data||[]).find(d => d.Sex===selectedSex && d.GroupedYear===fYr);
    const b = (feature.properties.data||[]).find(d => d.Sex===selectedSex && d.GroupedYear===lYr);
    if (!a || !b) return "#ccc";

    const diff = round1(b.Value - a.Value);
    return colors[Math.floor(Math.random()*7)]; // placeholder: user can customise if needed
  }

  function updateMapStyles(){
    if (mode === "absolute") computeBreaks(deaDataCache);

    deaLayer.eachLayer(layer => {
      const c = getFeatureColor(layer.feature);
      layer.setStyle({fillColor: c});
    });

    updateLegend();
  }

  function updateYearLabel(){
    document.getElementById("year-label").textContent = years[currentYearIndex];
  }

  /* Legend updated for 7-class inverted palette */
  function updateLegend(){
    const div = document.getElementById("legend-content");

    if (mode === "absolute"){
      const vals = [];

      deaDataCache.features.forEach(f => {
        const rec = (f.properties.data||[]).find(
          d => d.Sex === selectedSex && d.GroupedYear === years[currentYearIndex]
        );
        if (rec && typeof rec.Value === "number") vals.push(rec.Value);
      });

      const min = vals.length ? round1(Math.min(...vals)) : "n/a";
      const max = vals.length ? round1(Math.max(...vals)) : "n/a";

      let html = `<b>${selectedSex} (${years[currentYearIndex]})</b><br>`;
      html += `<small>min: ${min} — max: ${max}</small><br><br>`;

      html += `<i style="background:${colors[0]}"></i> ${min} – ${breaks[0]}<br>`;
      html += `<i style="background:${colors[1]}"></i> ${breaks[0]} – ${breaks[1]}<br>`;
      html += `<i style="background:${colors[2]}"></i> ${breaks[1]} – ${breaks[2]}<br>`;
      html += `<i style="background:${colors[3]}"></i> ${breaks[2]} – ${breaks[3]}<br>`;
      html += `<i style="background:${colors[4]}"></i> ${breaks[3]} – ${breaks[4]}<br>`;
      html += `<i style="background:${colors[5]}"></i> ${breaks[4]} – ${breaks[5]}<br>`;
      html += `<i style="background:${colors[6]}"></i> > ${breaks[5]}<br>`;

      div.innerHTML = html;
      return;
    }
  }

 function populateSidebar(feature){
  const props = feature.properties;
  const curVal = featureValue(feature);

  document.getElementById("sidebar-title").textContent =
    `DEA – ${props.finalr_dea}`;

  document.getElementById("sidebar-meta").innerHTML = `
    <strong>${selectedSex}</strong><br>
    Year: ${years[currentYearIndex]}<br>
    Value: ${curVal != null ? round1(curVal) + " yrs" : "n/a"}
  `;

  // Build chart for this DEA
  buildChart(feature);
}


 
  /* =====================================================
   Create sidebar line chart for selected DEA
===================================================== */

function buildChart(feature) {
  const ctx = document.getElementById("deaChart").getContext("2d");

  // Extract all years + values for the selected DEA + sex
  const records = years.map(y => {
    const rec = (feature.properties.data || []).find(
      d => d.Sex === selectedSex && d.GroupedYear === y
    );
    return rec ? rec.Value : null;
  });

  // If an old chart exists, destroy it first
  if (deaChart) deaChart.destroy();

  deaChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: years,
      datasets: [{
        label: selectedSex,
        data: records,
        borderWidth: 2,
        borderColor: "#0078A8",
        backgroundColor: "rgba(0,120,168,0.15)",
        pointRadius: 3,
        tension: 0.2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          title: { display: true, text: "Life expectancy (years)" },
          suggestedMin: Math.min(...records) - 0.5,
          suggestedMax: Math.max(...records) + 0.5
        },
        x: {
          title: { display: true, text: "Year" }
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });
}


  /* ============================
     UI CONTROLS
  ============================ */

  document.getElementById("year-slider").addEventListener("input", e => {
    currentYearIndex = Number(e.target.value);
    updateYearLabel();
    updateMapStyles();
  });

  document.getElementById("tab-males").onclick = () => {
    selectedSex = "Males";
    updateMapStyles();
  };
  document.getElementById("tab-females").onclick = () => {
    selectedSex = "Females";
    updateMapStyles();
  };

  document.getElementById("play-btn").onclick = () => {
    if (playInterval){
      clearInterval(playInterval);
      playInterval = null;
      document.getElementById("play-btn").textContent = "▶ Play Years";
    } else {
      document.getElementById("play-btn").textContent = "⏸ Pause";
      playInterval = setInterval(() => {
        currentYearIndex = (currentYearIndex + 1) % years.length;
        document.getElementById("year-slider").value = currentYearIndex;
        updateYearLabel();
        updateMapStyles();
      }, 1500);
    }
  };

  document.getElementById("close-sidebar").onclick = () => {
    document.getElementById("sidebar").style.display = "none";
  };

  document.querySelectorAll('input[name="mode"]').forEach(r => {
    r.addEventListener("change", e => {
      mode = e.target.value;
      updateMapStyles();
    });
  });

  </script>

</body>
</html>

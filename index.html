<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NI DEA Life Expectancy Map</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://unpkg.com/chart.js@4.3.0/dist/chart.umd.js"></script>
<!-- Chart.js Annotation -->
<script src="https://unpkg.com/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script>Chart.register(window['chartjs-plugin-annotation']);</script>

<style>
  :root{
    --control-width:220px;
    --sidebar-width:360px;
    --chart-min-height:150px; /* fallback minimum */
    --ui-bg: rgba(255,255,255,0.98);
    --muted:#666;
    --accent:#0078A8;
  }

  html,body{ height:100%; margin:0; font-family:Arial, sans-serif; -webkit-font-smoothing:antialiased;}
  #map{ height:100vh; width:100%; }

  /* Controls */
  .controls{
    position:absolute; left:10px; top:10px; z-index:1200;
    width:var(--control-width); background:var(--ui-bg); padding:8px; border-radius:6px;
    box-shadow:0 2px 6px rgba(0,0,0,0.18); font-size:13px;
  }
  .control-toggle{ position:absolute; right:6px; top:6px; border:none; background:transparent; cursor:pointer; color:var(--muted); }

  .tabs{ display:flex; gap:6px; margin-bottom:6px; }
  .tabs button{ flex:1; padding:6px 8px; border:none; background:#eee; border-radius:4px; cursor:pointer; }
  .tabs button.active{ background:var(--accent); color:#fff; }

  #year-slider{ width:100%; margin-top:8px; }
  #year-label{ margin-top:6px; font-weight:700; font-size:13px; }
  #play-btn{ margin-top:8px; padding:6px 10px; background:#eee; border-radius:4px; cursor:pointer; border:none; }

  /* Legend */
  .legend{ width:auto; min-width:0; padding:6px 8px; border-radius:6px; background:var(--ui-bg); box-shadow:0 1px 4px rgba(0,0,0,0.12); font-size:12px; line-height:1.3; }
  .legend-header{ display:flex; justify-content:space-between; align-items:center; gap:6px; margin-bottom:4px; }
  .legend-item{ display:flex; align-items:center; gap:6px; margin-bottom:4px; }
  .legend-swatch{ width:18px; height:14px; border-radius:3px; flex:0 0 auto; }

  /* Sidebar */
  #sidebar{
    position:absolute; right:10px; top:10px; z-index:1200;
    width:var(--sidebar-width); max-height:calc(100vh - 20px);
    background:var(--ui-bg); padding:10px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.18);
    overflow:auto; display:none;
  }
  #sidebar h3{ margin:0 0 6px 0; font-size:16px; }
  #sidebar-meta{ margin-bottom:8px; color:var(--muted); font-size:13px; }

  /* Chart container: we'll set height dynamically for safari safety */
  #chart-container{ height:auto; min-height:var(--chart-min-height); }

  /* NI average label (dashed) */
  #ni-average-label{ font-size:12px; color:#444; font-weight:bold; display:inline-flex; align-items:center; gap:6px; margin-bottom:8px; }
  #ni-average-line{
    display:inline-block;
    height:2px;
    background: repeating-linear-gradient(to right, #444 0, #444 5px, transparent 5px, transparent 10px);
    width:80px; /* default, will be resized */
  }

  /* DEA selection label (divIcon) */
  .dea-label{
    display:inline-block; font-weight:700; font-size:13px; line-height:1; padding:6px 8px;
    border-radius:6px; background:rgba(255,255,255,0.9); color:#111; box-shadow:0 1px 4px rgba(0,0,0,0.2);
    text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
    transform: translate(-50%,-50%); pointer-events:none;
  }

  /* small-screen adjustments */
  @media (max-width:900px){
    :root{ --control-width:260px; --sidebar-width:300px; }
  }
  @media (max-width:650px){
    :root{ --control-width:200px; --sidebar-width:90%; }
    .controls{ left:8px; top:8px; padding:6px; }
    #sidebar{ top:6px; right:6px; padding:8px; max-height:calc(100vh - 12px); }
  }

  /* transitions */
  .leaflet-interactive{ transition:fill .32s ease, fill-opacity .32s ease, stroke .28s ease; }
</style>
</head>
<body>

  <div id="map"></div>

  <!-- Controls -->
  <div class="controls" id="controls" role="region" aria-label="Map controls">
    <button class="control-toggle" id="controls-toggle" title="Collapse controls">▾</button>
    <div class="tabs" role="tablist">
      <button id="tab-males" class="active">Males</button>
      <button id="tab-females">Females</button>
    </div>

    <input type="range" id="year-slider" min="0" max="0" step="1" />
    <div id="year-label" aria-live="polite"></div>
    <button id="play-btn" aria-pressed="false">▶ Play Years</button>

    <div style="margin-top:8px; font-size:12px; color:var(--muted);">
      <div style="font-weight:700;">Data Display Mode</div>
      <label style="display:block; margin-top:6px;"><input type="radio" name="yaxis" value="dynamic"> Data by year</label>
      <label style="display:block; margin-top:6px;"><input type="radio" name="yaxis" value="fixed" checked> Data across years</label>
    </div>
  </div>

  <!-- Sidebar -->
  <div id="sidebar" aria-live="polite" role="region" aria-label="DEA details">
    <button id="close-sidebar" style="float:right">Close</button>
    <h3 id="sidebar-title"></h3>
    <div id="sidebar-meta"></div>

    <div id="chart-container">
      <div id="ni-average-label"><span>NI average:</span><span id="ni-average-line"></span></div>
      <canvas id="deaChart"></canvas>
    </div>
  </div>

<script>
/* -------------------
   Config & state
   ------------------- */
const geojsonUrl = 'DEA_data.geojson';
const colors = ["#28326f","#25588e","#2285b3","#86bad4","#dee8f1"];

let selectedSex = 'Males';
let years = [];
let currentYearIndex = 0;
let yAxisMode = 'fixed';

let deaDataCache = null;
let deaLayer = null;
let lastSelectedLayer = null;
let selectedLabelMarker = null;

let deaChart = null;
let playInterval = null;

let breaks = [];
let globalMinValue = null;
let globalMaxValue = null;

/* -------------------
   Map init
   ------------------- */
const map = L.map('map', { preferCanvas:true }).setView([54.7,-6.6],8);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap & Carto' }).addTo(map);

/* Legend control (keeps same behaviour) */
const legendControl = L.control({ position:'bottomright' });
legendControl.onAdd = function(){
  const div = L.DomUtil.create('div', 'legend');
  div.id = 'legend-control';
  div.innerHTML = `
    <div class="legend-header">
      <div id="legend-title" style="font-weight:700"></div>
      <button id="legend-toggle" class="toggle-legend">▾</button>
    </div>
    <div id="legend-body" style="margin-top:8px"></div>
  `;
  return div;
};
legendControl.addTo(map);

/* -------------------
   Fetch geojson
   ------------------- */
fetch(geojsonUrl)
  .then(r => { if(!r.ok) throw new Error('GeoJSON load failed: ' + r.status); return r.json(); })
  .then(data => {
    deaDataCache = data;

    // collect years
    const yearSet = new Set();
    deaDataCache.features.forEach(f => (f.properties.data||[]).forEach(d => yearSet.add(String(d.GroupedYear))));
    years = Array.from(yearSet).sort();
    if(!years.length) { alert('No year data found'); return; }

    document.getElementById('year-slider').max = years.length - 1;
    updateYearLabel();

    computeGlobalBounds();
    if(yAxisMode === 'fixed') computeGlobalBreaks(); else computeBreaks();

    createMapLayer();
    updateLegend();

    // fit to bounds once layer created
    map.fitBounds(deaLayer.getBounds(), { padding:[18,18] });
  })
  .catch(err => { console.error(err); alert('Error loading data: ' + err.message); });

/* -------------------
   Helpers
   ------------------- */
function round1(v){ return (typeof v === 'number') ? Math.round(v*10)/10 : v; }
function updateYearLabel(){ document.getElementById('year-label').textContent = years[currentYearIndex] || ''; }

function featureValueForYear(feature, yearIndex=currentYearIndex, sex=selectedSex){
  const year = years[yearIndex];
  const rec = (feature.properties.data||[]).find(d => d.Sex === sex && String(d.GroupedYear) === String(year));
  return rec && typeof rec.Value === 'number' ? rec.Value : null;
}

function computeNIAverage(sex = selectedSex){
  return years.map(y => {
    const vals = [];
    deaDataCache.features.forEach(f => {
      const rec = (f.properties.data||[]).find(d => d.Sex===sex && String(d.GroupedYear) === String(y));
      if(rec && typeof rec.Value === 'number') vals.push(rec.Value);
    });
    return vals.length ? round1(vals.reduce((a,b)=>a+b,0)/vals.length) : null;
  });
}

function computeGlobalBounds(){
  let lo = Infinity, hi = -Infinity;
  deaDataCache.features.forEach(f => (f.properties.data||[]).forEach(d => {
    if(typeof d.Value === 'number'){ if(d.Value < lo) lo = d.Value; if(d.Value > hi) hi = d.Value; }
  }));
  if(!isFinite(lo) || !isFinite(hi)){ globalMinValue = null; globalMaxValue = null; return; }
  globalMinValue = Math.floor(lo - 1);
  globalMaxValue = Math.ceil(hi + 1);
}

function computeBreaks(){
  const vals = [];
  deaDataCache.features.forEach(f => {
    const rec = (f.properties.data||[]).find(d => d.Sex===selectedSex && String(d.GroupedYear)===String(years[currentYearIndex]));
    if(rec && typeof rec.Value==='number') vals.push(rec.Value);
  });
  if(!vals.length){ breaks = []; return; }
  const min = Math.min(...vals), max = Math.max(...vals);
  const step = (max - min) / 5;
  breaks = Array.from({length:4}, (_,i) => round1(min + step*(i+1)));
}

function computeGlobalBreaks(){
  const vals = [];
  deaDataCache.features.forEach(f => (f.properties.data||[]).forEach(d => {
    if(d.Sex===selectedSex && typeof d.Value === 'number') vals.push(d.Value);
  }));
  if(!vals.length){ breaks = []; return; }
  const min = Math.min(...vals), max = Math.max(...vals);
  const step = (max - min) / 5;
  breaks = Array.from({length:4}, (_,i) => round1(min + step*(i+1)));
}

function getFeatureColor(feature){
  const v = featureValueForYear(feature);
  if(v == null || !breaks || breaks.length !== 4) return '#ccc';
  if(v <= breaks[0]) return colors[0];
  if(v <= breaks[1]) return colors[1];
  if(v <= breaks[2]) return colors[2];
  if(v <= breaks[3]) return colors[3];
  return colors[4];
}

/* -------------------
   Map layer + events
   ------------------- */
function createMapLayer(){
  deaLayer = L.geoJSON(deaDataCache, {
    style: feature => ({ weight:1, color:'#555', fillColor: getFeatureColor(feature), fillOpacity: 0.75 }),
    onEachFeature: (feature, layer) => {
      layer.on('mouseover', ()=>{ layer.bringToFront(); layer.setStyle({ weight:3, color:'#000', fillOpacity:1 }); });
      layer.on('mouseout', ()=>{ if(lastSelectedLayer && lastSelectedLayer === layer){ layer.setStyle({ weight:3, color:'#000', fillOpacity:1 }); } else { deaLayer.resetStyle(layer); } });
      layer.on('click', ()=> {
        if(lastSelectedLayer && lastSelectedLayer !== layer) deaLayer.resetStyle(lastSelectedLayer);
        lastSelectedLayer = layer;
        layer.setStyle({ weight:3, color:'#000', fillOpacity:1 });

        // show sidebar and ensure chart container/canvas have real pixel height
        const sb = document.getElementById('sidebar');
        sb.style.display = 'block';
        ensureChartContainerHasHeightThenBuild(layer.feature);
        addOrUpdateLabelForFeature(layer, feature);
      });
    }
  }).addTo(map);
}

/* -------------------
   Label helpers
   ------------------- */
function addOrUpdateLabelForFeature(layer, feature){
  if(selectedLabelMarker) { map.removeLayer(selectedLabelMarker); selectedLabelMarker = null; }
  const center = layer.getBounds().getCenter();
  const val = featureValueForYear(feature);
  const html = `<div class="dea-label">${val != null ? round1(val) : 'n/a'}</div>`;
  selectedLabelMarker = L.marker(center, { icon: L.divIcon({ html: html, className: 'dea-label-container', iconSize: null }), interactive:false }).addTo(map);
}
function removeLabel(){ if(selectedLabelMarker){ map.removeLayer(selectedLabelMarker); selectedLabelMarker = null; } }
function refreshSelectedLabel(){ if(!lastSelectedLayer || !lastSelectedLayer.feature) return; if(selectedLabelMarker) map.removeLayer(selectedLabelMarker); addOrUpdateLabelForFeature(lastSelectedLayer, lastSelectedLayer.feature); }

/* -------------------
   Legend
   ------------------- */
function updateLegend(){
  const title = document.getElementById('legend-title');
  const body = document.getElementById('legend-body');
  if(!title || !body) return;

  let minDisplay, maxDisplay;
  if(yAxisMode === 'fixed'){
    minDisplay = (globalMinValue != null) ? globalMinValue : 'n/a';
    maxDisplay = (globalMaxValue != null) ? globalMaxValue : 'n/a';
  } else {
    const vals = [];
    deaDataCache.features.forEach(f=>{
      const rec = (f.properties.data||[]).find(d=>d.Sex===selectedSex && String(d.GroupedYear)===String(years[currentYearIndex]));
      if(rec && typeof rec.Value === 'number') vals.push(rec.Value);
    });
    minDisplay = vals.length ? round1(Math.min(...vals)) : 'n/a';
    maxDisplay = vals.length ? round1(Math.max(...vals)) : 'n/a';
  }

  title.textContent = `${selectedSex} (${years[currentYearIndex]})`;

  if(!breaks || breaks.length !== 4){
    body.innerHTML = `<small>Range: ${minDisplay} to ${maxDisplay} years</small><br><br><div>No break data</div>`;
    return;
  }

  const labels = [
    `${minDisplay} – ${breaks[0]}`,
    `${breaks[0]} – ${breaks[1]}`,
    `${breaks[1]} – ${breaks[2]}`,
    `${breaks[2]} – ${breaks[3]}`,
    `> ${breaks[3]}`
  ];

  let html = `<small>Range: ${minDisplay} to ${maxDisplay} years</small><br><br>`;
  for(let i=0;i<5;i++){
    html += `<div class="legend-item"><div class="legend-swatch" style="background:${colors[i]}"></div><div>${labels[i]}</div></div>`;
  }
  body.innerHTML = html;
}

/* Legend toggle behaviour */
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id === 'legend-toggle'){
    const body = document.getElementById('legend-body');
    if(!body) return;
    if(body.style.display === 'none' || body.style.display === ''){ body.style.display = 'block'; e.target.textContent = '▾'; }
    else { body.style.display = 'none'; e.target.textContent = '▸'; }
  }
});
(function autoCollapseLegendOnSmall(){
  const mq = window.matchMedia('(max-width:650px)');
  function handler(m){
    const btn = document.getElementById('legend-toggle');
    const body = document.getElementById('legend-body');
    if(!btn || !body) return;
    if(m.matches){ body.style.display='none'; btn.textContent='▸'; document.querySelector('.legend')?.classList.add('collapsed'); }
    else { body.style.display='block'; btn.textContent='▾'; document.querySelector('.legend')?.classList.remove('collapsed'); }
  }
  handler(mq);
  mq.addListener(handler);
})();

/* -------------------
   Chart: Safari-friendly build
   ------------------- */
function ensureChartContainerHasHeightThenBuild(feature){
  // Set chart container height in pixels based on viewport but keep minimum
  const container = document.getElementById('chart-container');
  const sidebar = document.getElementById('sidebar');

  // Compute desired pixel height: on small screens give larger fraction; otherwise use CSS variable fallback
  let desiredPx = Math.max(150, Math.round(window.innerHeight * (window.innerWidth <= 650 ? 0.40 : 0.30)));
  container.style.height = desiredPx + 'px';

  // Also set canvas CSS height and attribute (important for Safari)
  const canvas = document.getElementById('deaChart');
  canvas.style.width = '100%';
  canvas.style.height = desiredPx + 'px';
  // set the canvas pixel height attribute to match CSS height (ensures Chart.js draws correctly)
  canvas.width = canvas.offsetWidth;
  canvas.height = desiredPx;

  // Delay a bit so browser lays out the sidebar/container, then build chart & resize
  setTimeout(() => {
    buildChart(feature);
    // ensure Chart.js recalculates sizes (extra safety)
    if(deaChart) deaChart.resize();
    // also update NI dashed line width
    adjustNIaverageLine();
  }, 120);
}

function buildChart(feature){
  const ctx = document.getElementById('deaChart').getContext('2d');

  const deaRecords = years.map(y => {
    const rec = (feature.properties.data||[]).find(d => d.Sex === selectedSex && String(d.GroupedYear) === String(y));
    return rec && typeof rec.Value === 'number' ? round1(rec.Value) : null;
  });

  const niRecords = computeNIAverage(selectedSex);

  // compute y bounds
  let chartMin = null, chartMax = null;
  if(yAxisMode === 'fixed' && globalMinValue != null && globalMaxValue != null){
    chartMin = globalMinValue; chartMax = globalMaxValue;
  } else {
    const combined = [];
    deaRecords.forEach(v => { if(typeof v === 'number') combined.push(v); });
    niRecords.forEach(v => { if(typeof v === 'number') combined.push(v); });
    if(combined.length){ chartMin = Math.floor(Math.min(...combined)-1); chartMax = Math.ceil(Math.max(...combined)+1); }
  }

  const selIdx = currentYearIndex;
  if(deaChart) deaChart.destroy();

  deaChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: years,
      datasets: [
        {
          label: feature.properties.finalr_dea || 'DEA',
          data: deaRecords,
          borderColor: '#0078A8',
          backgroundColor: 'rgba(0,120,168,0.16)',
          fill: true,
          pointRadius: 3,
          tension: 0.25,
          borderWidth: 2
        },
        {
          label: 'Northern Ireland (avg)',
          data: niRecords,
          borderColor: '#444',
          backgroundColor: 'transparent',
          fill: false,
          borderDash: [5,5],
          pointRadius: 0,
          tension: 0.25,
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales: {
        x: { title: { display:true, text:'Period' } },
        y: { title: { display:true, text:'HLE (years)' }, min: chartMin, max: chartMax }
      },
      plugins: {
        legend: { display: false },
        annotation: {
          annotations: {
            shadeLeft: { type:'box', xMin: 0, xMax: selIdx, backgroundColor:'rgba(0,0,0,0.04)' },
            currentYearLine: { type:'line', xMin: selIdx, xMax: selIdx, borderColor:'rgba(0,0,0,0.45)', borderDash:[4,4], borderWidth:1 }
          }
        }
      }
    }
  });

  // ensure dashed label width is proportional once chart exists
  adjustNIaverageLine();
}

/* Keeps NI dashed line sized sensibly (1/3 of chart width, capped) */
function adjustNIaverageLine(){
  const chartCanvas = document.getElementById('deaChart');
  const niLine = document.getElementById('ni-average-line');
  if(chartCanvas && niLine){
    niLine.style.width = Math.min(chartCanvas.offsetWidth / 3, 120) + 'px';
  }
}

/* Called when year changes: update annotation and dashed line */
function updateSidebarChartForSelectedYear(){
  if(!deaChart) return;
  const idx = currentYearIndex;
  const ann = deaChart.options.plugins.annotation.annotations;
  if(ann){
    if(ann.currentYearLine){ ann.currentYearLine.xMin = idx; ann.currentYearLine.xMax = idx; }
    if(ann.shadeLeft) ann.shadeLeft.xMax = idx;
  }
  deaChart.update();
  adjustNIaverageLine();
}

/* -------------------
   Populate sidebar
   ------------------- */
function populateSidebar(feature){
  const props = feature.properties || {};
  const cur = featureValueForYear(feature);
  document.getElementById('sidebar-title').textContent = `DEA – ${props.finalr_dea || 'Unknown'}`;
  document.getElementById('sidebar-meta').innerHTML = `<strong>${selectedSex}</strong><br>Period: ${years[0]} → ${years[years.length-1]}<br>Current (${years[currentYearIndex]}): ${cur != null ? round1(cur) + ' yrs' : 'n/a'}`;
  // build chart (ensureChart... will set sizes and call buildChart)
  ensureChartContainerHasHeightThenBuild(feature);
}

/* -------------------
   UI Events
   ------------------- */
function updateTabsUI(){
  document.getElementById('tab-males').classList.remove('active');
  document.getElementById('tab-females').classList.remove('active');
  if(selectedSex === 'Males') document.getElementById('tab-males').classList.add('active');
  else document.getElementById('tab-females').classList.add('active');
}
document.getElementById('tab-males').onclick = () => { selectedSex = 'Males'; updateTabsUI(); computeBreaks(); computeGlobalBreaks(); if(deaLayer) deaLayer.eachLayer(l => l.setStyle({ fillColor: getFeatureColor(l.feature) })); refreshSelectedLabel(); if(lastSelectedLayer) populateSidebar(lastSelectedLayer.feature); };
document.getElementById('tab-females').onclick = () => { selectedSex = 'Females'; updateTabsUI(); computeBreaks(); computeGlobalBreaks(); if(deaLayer) deaLayer.eachLayer(l => l.setStyle({ fillColor: getFeatureColor(l.feature) })); refreshSelectedLabel(); if(lastSelectedLayer) populateSidebar(lastSelectedLayer.feature); };

document.getElementById('year-slider').addEventListener('input', e => {
  currentYearIndex = Number(e.target.value);
  updateYearLabel();
  updateSidebarChartForSelectedYear();
  if(deaLayer) deaLayer.eachLayer(l => l.setStyle({ fillColor: getFeatureColor(l.feature) }));
  refreshSelectedLabel();
});

document.getElementById('play-btn').addEventListener('click', () => {
  if(playInterval){ clearInterval(playInterval); playInterval = null; document.getElementById('play-btn').textContent = '▶ Play Years'; return; }
  document.getElementById('play-btn').textContent = '⏸ Pause';
  playInterval = setInterval(() => {
    currentYearIndex = (currentYearIndex + 1) % years.length;
    document.getElementById('year-slider').value = currentYearIndex;
    updateYearLabel();
    updateSidebarChartForSelectedYear();
    if(deaLayer) deaLayer.eachLayer(l => l.setStyle({ fillColor: getFeatureColor(l.feature) }));
    refreshSelectedLabel();
  }, 1400);
});

document.querySelectorAll('input[name="yaxis"]').forEach(r => {
  r.addEventListener('change', e => {
    yAxisMode = e.target.value;
    if(yAxisMode === 'fixed'){ computeGlobalBounds(); computeGlobalBreaks(); } else computeBreaks();
    if(deaLayer) deaLayer.eachLayer(l => l.setStyle({ fillColor: getFeatureColor(l.feature) }));
    if(lastSelectedLayer) populateSidebar(lastSelectedLayer.feature);
    refreshSelectedLabel();
  });
});

document.getElementById('controls-toggle').addEventListener('click', () => {
  const c = document.getElementById('controls');
  if(c.classList.contains('min')){ c.classList.remove('min'); document.getElementById('controls-toggle').textContent='▾'; }
  else { c.classList.add('min'); document.getElementById('controls-toggle').textContent='▸'; }
});

document.getElementById('close-sidebar').addEventListener('click', ()=> {
  document.getElementById('sidebar').style.display = 'none';
  if(lastSelectedLayer) deaLayer.resetStyle(lastSelectedLayer);
  lastSelectedLayer = null;
  removeLabel();
});

/* hide sidebar on map click on small screens */
map.on('click', () => {
  if(window.innerWidth <= 650){
    document.getElementById('sidebar').style.display = 'none';
    if(lastSelectedLayer) deaLayer.resetStyle(lastSelectedLayer);
    lastSelectedLayer = null;
    removeLabel();
  }
});

/* initial UI state */
updateTabsUI();

/* -------------------
   Resize handling (incl. rotation)
   ------------------- */
window.addEventListener('resize', () => {
  // if sidebar visible, recompute container height & resize chart
  if(document.getElementById('sidebar').style.display === 'block'){
    const container = document.getElementById('chart-container');
    const desiredPx = Math.max(150, Math.round(window.innerHeight * (window.innerWidth <= 650 ? 0.40 : 0.30)));
    container.style.height = desiredPx + 'px';
    const canvas = document.getElementById('deaChart');
    canvas.style.height = desiredPx + 'px';
    // set pixel dims to help Safari
    canvas.width = canvas.offsetWidth;
    canvas.height = desiredPx;
    if(deaChart) { deaChart.resize(); adjustNIaverageLine(); }
  }
});

</script>
</body>
</html>

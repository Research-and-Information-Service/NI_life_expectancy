<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NI DEA Life Expectancy Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://unpkg.com/chart.js@4.3.0/dist/chart.umd.js"></script>

  <!-- Chart.js Annotation Plugin -->
  <script src="https://unpkg.com/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script>Chart.register(window['chartjs-plugin-annotation']);</script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; }

    .controls {
      position: absolute;
      top: 10px; left: 10px; z-index: 1000;
      background: white; padding: 10px; border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      width: 340px;
    }
    .tabs { margin-bottom: 6px; }
    .tabs button {
      margin: 2px; padding: 6px 10px; border: none; cursor: pointer;
      background: #eee; border-radius: 4px;
    }
    .tabs button.active { background: #0078A8; color: white; }

    #year-slider { width: 100%; margin-top: 8px; }

    #play-btn {
      margin-top: 6px; padding: 6px 10px;
      background: #eee; border-radius: 4px; cursor: pointer;
    }

    .legend { background: white; padding: 6px; border-radius: 4px; font-size: 12px; }
    .legend i {
      width: 18px; height: 18px;
      float: left; margin-right: 8px;
      opacity: 0.95;
    }
    .legend:after { content: ""; display: block; clear: both; }

    #sidebar {
      position: absolute;
      right: 10px;
      top: 10px;
      width: 420px;
      max-height: calc(100vh - 20px);
      overflow: auto;
      z-index: 1000;
      background: white;
      padding: 12px;
      border-radius: 6px;
      display: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #chart-container { height: 260px; }

    #spinner {
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 2000;
    }
    .spinner-dot {
      width: 16px; height: 16px; margin: 4px;
      border-radius: 50%;
      background: #0078A8; opacity: 0.9;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { 0% {transform:scale(1);} 50% {transform:scale(0.45);} 100% {transform:scale(1);} }

    .leaflet-interactive {
      transition: fill 600ms ease, fill-opacity 600ms ease, stroke 300ms ease;
    }

    #assembly-logo {
      position: absolute;
      bottom: 10px;
      left: 10px;
      width: 140px;
      z-index: 1100;
      opacity: 0.95;
      pointer-events: none;
    }

    @media (max-width: 900px) {
      .controls { width: 280px; }
      #sidebar { width: 320px; }
    }
  </style>
</head>
<body>

  <div id="map"></div>
  <img id="assembly-logo" src="NI_Assembly.svg" alt="NI Assembly Logo">

  <div id="spinner">
    <div class="spinner-dot" style="animation-delay:0s"></div>
    <div class="spinner-dot" style="animation-delay:0.12s"></div>
    <div class="spinner-dot" style="animation-delay:0.24s"></div>
  </div>

  <div class="controls">
    <div class="tabs">
      <button id="tab-males" class="active">Males</button>
      <button id="tab-females">Females</button>
    </div>

    <input type="range" id="year-slider" min="0" max="0" step="1" value="0">
    <div id="year-label" style="margin-top:5px;font-weight:bold;"></div>
    <button id="play-btn">▶ Play Years</button>

    <div style="margin-top:10px;">
  <b>Data Display Mode</b><br>

  <label>
    <input type="radio" name="yaxis" value="dynamic">
    Data by Year (adjust scale to selected year)
  </label><br>

  <label>
    <input type="radio" name="yaxis" value="fixed" checked>
    Data across Years (use full NI data range)
  </label>
</div>

  </div>

  <div id="sidebar">
    <button id="close-sidebar" style="float:right">Close</button>
    <h3 id="sidebar-title">DEA details</h3>
    <div id="sidebar-meta"></div>
    <div id="chart-container"><canvas id="deaChart"></canvas></div>
  </div>

<script>
/* -----------------------------------------
   CONFIG
----------------------------------------- */

const colors = [
  "#28326f", "#265188", "#246b9e", "#2285b3",
  "#6baccb", "#b4d2e3", "#dee8f1"
];

const geojsonUrl = "DEA_data.geojson";

let selectedSex = "Males";
let years = [];
let currentYearIndex = 0;
let yAxisMode = "fixed";

let deaDataCache = null;
let deaLayer = null;
let lastHoveredLayer = null;
let deaChart = null;
let playInterval = null;

let breaks = [];
let globalMinValue = null;
let globalMaxValue = null;

/* -----------------------------------------
   MAP INITIALISATION
----------------------------------------- */

const map = L.map("map").setView([54.7, -6.6], 8);
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap & Carto"
}).addTo(map);

const legend = L.control({ position: "bottomright" });
legend.onAdd = () => {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = '<div id="legend-content"></div>';
  return div;
};
legend.addTo(map);

/* -----------------------------------------
   SPINNER
----------------------------------------- */

function showSpinner(on = true) {
  document.getElementById("spinner").style.display = on ? "block" : "none";
}

showSpinner(true);

/* -----------------------------------------
   LOAD GEOJSON
----------------------------------------- */

fetch(geojsonUrl)
  .then(r => r.json())
  .then(data => {
    deaDataCache = data;

    const yearSet = new Set();
    data.features.forEach(f => {
      (f.properties.data || []).forEach(d => yearSet.add(d.GroupedYear));
    });

    years = Array.from(yearSet).sort();
    document.getElementById("year-slider").max = years.length - 1;
    updateYearLabel();

    computeGlobalBounds();
    computeBreaks();

    createMapLayer();
    updateLegend();

    map.fitBounds(deaLayer.getBounds(), { padding: [20, 20] });

    showSpinner(false);
  });

/* -----------------------------------------
   YEAR + SEX HELPERS
----------------------------------------- */

function updateYearLabel() {
  document.getElementById("year-label").textContent = years[currentYearIndex];
}

function round1(v) {
  return (typeof v === "number") ? Math.round(v * 10) / 10 : v;
}

function featureValue(feature, yearIndex = currentYearIndex, sex = selectedSex) {
  const y = years[yearIndex];
  const rec = (feature.properties.data || [])
    .find(d => d.Sex === sex && d.GroupedYear === y);
  return rec ? rec.Value : null;
}

/* -----------------------------------------
   NI AVERAGE (simple mean)
----------------------------------------- */

function computeNIAverage(sex) {
  return years.map(y => {
    const vals = [];
    deaDataCache.features.forEach(f => {
      const rec = (f.properties.data || [])
        .find(d => d.Sex === sex && d.GroupedYear === y);
      if (rec && typeof rec.Value === "number") vals.push(rec.Value);
    });
    if (!vals.length) return null;
    return round1(vals.reduce((a, b) => a + b, 0) / vals.length);
  });
}

/* -----------------------------------------
   BREAKS / SCALES
----------------------------------------- */

function computeGlobalBounds() {
  let gmin = Infinity, gmax = -Infinity;

  deaDataCache.features.forEach(f => {
    (f.properties.data || []).forEach(d => {
      if (typeof d.Value === "number") {
        if (d.Value < gmin) gmin = d.Value;
        if (d.Value > gmax) gmax = d.Value;
      }
    });
  });

  globalMinValue = Math.floor(gmin - 1);
  globalMaxValue = Math.ceil(gmax + 1);
}

function computeBreaks() {
  const vals = [];

  deaDataCache.features.forEach(f => {
    const rec = (f.properties.data || [])
      .find(d => d.Sex === selectedSex && d.GroupedYear === years[currentYearIndex]);
    if (rec && typeof rec.Value === "number") vals.push(rec.Value);
  });

  if (!vals.length) return;

  const min = Math.min(...vals);
  const max = Math.max(...vals);
  const step = (max - min) / 7;

  breaks = Array.from({ length: 6 }, (_, i) =>
    round1(min + step * (i + 1))
  );
}

/* -----------------------------------------
   MAP COLOURING
----------------------------------------- */

function getFeatureColor(feature) {
  const val = featureValue(feature);
  if (val == null || !breaks.length) return "#ccc";

  if (val <= breaks[0]) return colors[0];
  if (val <= breaks[1]) return colors[1];
  if (val <= breaks[2]) return colors[2];
  if (val <= breaks[3]) return colors[3];
  if (val <= breaks[4]) return colors[4];
  if (val <= breaks[5]) return colors[5];
  return colors[6];
}

function updateMapStyles() {
  computeBreaks();

  deaLayer.eachLayer(layer => {
    const col = getFeatureColor(layer.feature);
    layer.setStyle({ fillColor: col });
  });

  updateLegend();
}

/* -----------------------------------------
   LEGEND
----------------------------------------- */

function updateLegend() {
  const div = document.getElementById("legend-content");

  const vals = [];
  deaDataCache.features.forEach(f => {
    const rec = (f.properties.data || [])
      .find(d => d.Sex === selectedSex && d.GroupedYear === years[currentYearIndex]);
    if (rec && typeof rec.Value === "number") vals.push(rec.Value);
  });

  const min = vals.length ? round1(Math.min(...vals)) : "n/a";
  const max = vals.length ? round1(Math.max(...vals)) : "n/a";

  let html = `<b>${selectedSex} (${years[currentYearIndex]})</b><br>`;
  html += `<small>min: ${min} — max: ${max}</small><br><br>`;

  if (breaks.length === 6) {
    html += `<i style="background:${colors[0]}"></i> ${min} – ${breaks[0]}<br>`;
    html += `<i style="background:${colors[1]}"></i> ${breaks[0]} – ${breaks[1]}<br>`;
    html += `<i style="background:${colors[2]}"></i> ${breaks[1]} – ${breaks[2]}<br>`;
    html += `<i style="background:${colors[3]}"></i> ${breaks[2]} – ${breaks[3]}<br>`;
    html += `<i style="background:${colors[4]}"></i> ${breaks[3]} – ${breaks[4]}<br>`;
    html += `<i style="background:${colors[5]}"></i> ${breaks[4]} – ${breaks[5]}<br>`;
    html += `<i style="background:${colors[6]}"></i> > ${breaks[5]}<br>`;
  }

  div.innerHTML = html;
}

/* -----------------------------------------
   CREATE MAP LAYER
----------------------------------------- */

function createMapLayer() {
  deaLayer = L.geoJSON(deaDataCache, {
    style: feature => ({
      weight: 1,
      color: "#555",
      fillOpacity: 0.85,
      fillColor: getFeatureColor(feature)
    }),
    onEachFeature: (feature, layer) => {
      layer.on("mouseover", () => {
        if (lastHoveredLayer && lastHoveredLayer !== layer)
          deaLayer.resetStyle(lastHoveredLayer);

        lastHoveredLayer = layer;
        layer.setStyle({ weight: 3, color: "#000", fillOpacity: 1 });

        populateSidebar(feature);
        document.getElementById("sidebar").style.display = "block";
      });

      layer.on("mouseout", () => {
        deaLayer.resetStyle(layer);
        lastHoveredLayer = null;
        document.getElementById("sidebar").style.display = "none";

        if (deaChart) { deaChart.destroy(); deaChart = null; }
      });
    }
  }).addTo(map);
}

/* -----------------------------------------
   CHART
----------------------------------------- */

function buildChart(feature) {
  const ctx = document.getElementById("deaChart").getContext("2d");

  const deaRecords = years.map(y => {
    const rec = (feature.properties.data || [])
      .find(d => d.Sex === selectedSex && d.GroupedYear === y);
    return rec ? round1(rec.Value) : null;
  });

  const niRecords = computeNIAverage(selectedSex);

  let chartMin = null;
  let chartMax = null;

  if (yAxisMode === "fixed") {
    chartMin = globalMinValue;
    chartMax = globalMaxValue;
  } else {
    const combined = [
      ...deaRecords.filter(v => typeof v === "number"),
      ...niRecords.filter(v => typeof v === "number")
    ];

    if (combined.length) {
      chartMin = Math.floor(Math.min(...combined) - 1);
      chartMax = Math.ceil(Math.max(...combined) + 1);
    }
  }

  const selectedIndex = currentYearIndex;

  if (deaChart) deaChart.destroy();

  deaChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: years,
      datasets: [
        {
          label: feature.properties.finalr_dea || "DEA",
          data: deaRecords,
          borderColor: "#0078A8",
          backgroundColor: "rgba(0,120,168,0.16)",
          fill: true,
          pointRadius: 3,
          tension: 0.3,
          borderWidth: 2
        },
        {
          label: "Northern Ireland (avg)",
          data: niRecords,
          borderColor: "#444",
          backgroundColor: "transparent",
          fill: false,
          borderDash: [5,5],
          pointRadius: 0,
          tension: 0.3,
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales: {
        x: { title: { display: true, text: "Period" } },
        y: {
          title: { display: true, text: "HLE (years)" },
          min: chartMin,
          max: chartMax
        }
      },
      plugins: {
        legend: { display: false },
        annotation: {
          annotations: {
            shadeLeft: {
              type: "box",
              xMin: 0,
              xMax: selectedIndex,
              backgroundColor: "rgba(0,0,0,0.04)"
            },
            currentYearLine: {
              type: "line",
              xMin: selectedIndex,
              xMax: selectedIndex,
              borderColor: "rgba(0,0,0,0.45)",
              borderWidth: 1,
              borderDash: [4,4]
            }
          }
        }
      }
    }
  });
}

function updateSidebarChartForSelectedYear() {
  if (!deaChart) return;

  const idx = currentYearIndex;
  const ann = deaChart.options.plugins.annotation.annotations;

  ann.currentYearLine.xMin = idx;
  ann.currentYearLine.xMax = idx;
  ann.shadeLeft.xMax = idx;

  deaChart.update();
}

/* -----------------------------------------
   SIDEBAR
----------------------------------------- */

function populateSidebar(feature) {
  const props = feature.properties;
  const curVal = featureValue(feature);

  document.getElementById("sidebar-title").textContent =
    `DEA – ${props.finalr_dea}`;

  document.getElementById("sidebar-meta").innerHTML = `
    <strong>${selectedSex}</strong><br>
    Period: ${years[0]} → ${years[years.length - 1]}<br>
    Current (${years[currentYearIndex]}): ${curVal != null ? round1(curVal) + " yrs" : "n/a"}
  `;

  buildChart(feature);
}

/* -----------------------------------------
   UI EVENTS
----------------------------------------- */

function updateTabs() {
  document.getElementById("tab-males").classList.remove("active");
  document.getElementById("tab-females").classList.remove("active");
  if (selectedSex === "Males") document.getElementById("tab-males").classList.add("active");
  else document.getElementById("tab-females").classList.add("active");
}

document.getElementById("tab-males").onclick = () => {
  selectedSex = "Males";
  updateTabs();
  computeBreaks();
  updateMapStyles();
  if (lastHoveredLayer) populateSidebar(lastHoveredLayer.feature);
};

document.getElementById("tab-females").onclick = () => {
  selectedSex = "Females";
  updateTabs();
  computeBreaks();
  updateMapStyles();
  if (lastHoveredLayer) populateSidebar(lastHoveredLayer.feature);
};

document.getElementById("year-slider").addEventListener("input", e => {
  currentYearIndex = Number(e.target.value);
  updateYearLabel();
  updateMapStyles();
  updateSidebarChartForSelectedYear();
});

document.getElementById("play-btn").addEventListener("click", () => {
  if (playInterval) {
    clearInterval(playInterval);
    playInterval = null;
    document.getElementById("play-btn").textContent = "▶ Play Years";
    return;
  }

  document.getElementById("play-btn").textContent = "⏸ Pause";
  playInterval = setInterval(() => {
    currentYearIndex = (currentYearIndex + 1) % years.length;
    document.getElementById("year-slider").value = currentYearIndex;
    updateYearLabel();
    updateMapStyles();
    updateSidebarChartForSelectedYear();
  }, 1400);
});

document.getElementById("close-sidebar").onclick = () => {
  document.getElementById("sidebar").style.display = "none";
  if (lastHoveredLayer) deaLayer.resetStyle(lastHoveredLayer);
  lastHoveredLayer = null;
  if (deaChart) { deaChart.destroy(); deaChart = null; }
};

document.querySelectorAll('input[name="yaxis"]').forEach(r => {
  r.addEventListener("change", e => {
    yAxisMode = e.target.value;
    if (lastHoveredLayer) populateSidebar(lastHoveredLayer.feature);
  });
});

updateTabs();
</script>

</body>
</html>
